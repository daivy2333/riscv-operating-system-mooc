æ²¡é—®é¢˜ï¼GDB å¯¹äºæ“ä½œç³»ç»Ÿå¼€å‘è‡³å…³é‡è¦ï¼Œå°¤å…¶æ˜¯æ­é… QEMU è°ƒè¯• RISC-V å†…æ ¸ã€‚ä¸‹é¢ç»™ä½ ä¸€ä»½**ä¸“ä¸º RISC-V å†…æ ¸è°ƒè¯•å®šåˆ¶çš„ã€é›¶åŸºç¡€å‹å¥½çš„ GDB å®æˆ˜é€ŸæˆæŒ‡å—**ï¼Œåªè®²ä½ é©¬ä¸Šèƒ½ç”¨çš„æ ¸å¿ƒæ“ä½œã€‚

---

### ğŸ› ï¸ ä¸€ã€å‡†å¤‡å·¥ä½œï¼šç¡®ä¿è°ƒè¯•ç¯å¢ƒå¯ç”¨

1. **ç¼–è¯‘æ—¶åŠ è°ƒè¯•ä¿¡æ¯**ï¼ˆå…³é”®ï¼ï¼‰
   ```bash
   # åœ¨ä½ çš„ Makefile ä¸­ï¼Œç¡®ä¿ CFLAGS åŒ…å« -g -O0
   CFLAGS = -march=rv64imac -mabi=lp64 -static -g -O0 -Wall
   ```
   - `-g`ï¼šç”Ÿæˆè°ƒè¯•ä¿¡æ¯ï¼ˆè®© GDB çŸ¥é“å“ªè¡Œ C å¯¹åº”å“ªæ¡æ±‡ç¼–ï¼‰
   - `-O0`ï¼šå…³é—­ä¼˜åŒ–ï¼ˆé¿å…ä»£ç é¡ºåºé”™ä¹±ï¼Œæ–¹ä¾¿å•æ­¥ï¼‰

2. **é‡æ–°ç¼–è¯‘å†…æ ¸**
   ```bash
   make clean
   make
   # åº”ç”Ÿæˆ kernel.elfï¼ˆå«è°ƒè¯•ä¿¡æ¯ï¼‰å’Œ kernel.bin
   ```

---

### ğŸš€ äºŒã€GDB + QEMU è”åˆè°ƒè¯•ï¼ˆæ ‡å‡†æµç¨‹ï¼‰

#### â–¶ï¸ æ­¥éª¤ 1ï¼šå¯åŠ¨ QEMU å¹¶ç›‘å¬ GDB ç«¯å£ï¼ˆ**ä¸è¿è¡Œï¼Œåªç­‰è¿æ¥**ï¼‰
```bash
qemu-system-riscv64 \
    -machine virt \
    -bios none \
    -kernel kernel.elf \
    -nographic \
    -S -gdb tcp::1234
```
- `-S`ï¼šå¯åŠ¨å**æš‚åœ CPU**ï¼Œç­‰å¾… GDB è¿æ¥ã€‚
- `-gdb tcp::1234`ï¼šåœ¨ 1234 ç«¯å£ç­‰ GDBã€‚

âœ… æ­¤æ—¶ç»ˆç«¯å¡ä½â€”â€”QEMU å·²å¯åŠ¨ï¼Œä½† CPU åœåœ¨ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼ˆ0x80200000 é™„è¿‘ï¼‰ï¼Œ**ç­‰ä½ è°ƒè¯•**ã€‚

---

#### â–¶ï¸ æ­¥éª¤ 2ï¼šå¦å¼€ç»ˆç«¯ï¼Œå¯åŠ¨ GDB å¹¶è¿æ¥
```bash
# å¯åŠ¨ GDBï¼ˆæ³¨æ„ï¼šè¦ç”¨ multiarch æ”¯æŒ RISC-Vï¼‰
gdb-multiarch kernel.elf
```

åœ¨ GDB äº¤äº’ç•Œé¢ä¸­è¾“å…¥ï¼š
```gdb
(gdb) target remote :1234       # è¿æ¥ QEMU
(gdb) set arch riscv:rv64       # æ˜¾å¼æŒ‡å®šæ¶æ„ï¼ˆè‹¥è‡ªåŠ¨è¯†åˆ«å¤±è´¥ï¼‰
(gdb) load                      # å°† kernel.elf åŠ è½½åˆ° QEMU å†…å­˜ï¼ˆé‡è¦ï¼ï¼‰
(gdb) break main                # åœ¨ C å‡½æ•° main å¤„è®¾æ–­ç‚¹
(gdb) continue                  # è®© QEMU ç»§ç»­è¿è¡Œï¼Œç›´åˆ° main
```

> ğŸ’¡ `load` æ˜¯å…³é”®ï¼å› ä¸º `-kernel` åªåŠ è½½äºŒè¿›åˆ¶ï¼ŒGDB éœ€é€šè¿‡ `load` æŠŠå«è°ƒè¯•ç¬¦å·çš„ `.elf` åŒæ­¥è¿‡å»ã€‚

---

### ğŸ” ä¸‰ã€GDB æœ€å¸¸ç”¨ 10 ä¸ªå‘½ä»¤ï¼ˆRISC-V å†…æ ¸è°ƒè¯•ä¸“ç”¨ï¼‰

| å‘½ä»¤ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|
| `break main` æˆ– `b main` | åœ¨ `main` å‡½æ•°è®¾æ–­ç‚¹ | `b trap.c:15` |
| `continue` æˆ– `c` | ç»§ç»­è¿è¡Œç›´åˆ°æ–­ç‚¹ | `c` |
| `step` æˆ– `s` | å•æ­¥è¿›å…¥ï¼ˆè¿›å‡½æ•°ï¼‰ | `s` |
| `next` æˆ– `n` | å•æ­¥è·³è¿‡ï¼ˆä¸è¿›å‡½æ•°ï¼‰ | `n` |
| `print x` æˆ– `p x` | æ‰“å°å˜é‡ `x` çš„å€¼ | `p count` |
| `info registers` æˆ– `i r` | æŸ¥çœ‹æ‰€æœ‰å¯„å­˜å™¨ | `i r a0`ï¼ˆåªçœ‹ a0ï¼‰|
| `x/10i $pc` | æŸ¥çœ‹å½“å‰ PC é™„è¿‘ 10 æ¡æ±‡ç¼– | `x/5i $pc` |
| `disassemble main` | åæ±‡ç¼– `main` å‡½æ•° | `disas start` |
| `backtrace` æˆ– `bt` | æŸ¥çœ‹å‡½æ•°è°ƒç”¨æ ˆ | `bt` |
| `quit` æˆ– `q` | é€€å‡º GDB | `q` |

---

### ğŸ“Œ å››ã€å…³é”®æŠ€å·§ & å¸¸è§é—®é¢˜

#### âœ… æŠ€å·§ 1ï¼šæŸ¥çœ‹ `start.S` å¯åŠ¨ä»£ç 
```gdb
(gdb) layout asm    # åˆ†å±æ˜¾ç¤ºæ±‡ç¼–ï¼ˆéœ€æ”¯æŒ TUIï¼‰
(gdb) stepi         # å•æ­¥æ‰§è¡Œæ±‡ç¼–æŒ‡ä»¤ï¼ˆæ¯” `s` æ›´åº•å±‚ï¼‰
(gdb) info registers ra, sp, gp   # åªçœ‹å…³é”®å¯„å­˜å™¨
```

#### âœ… æŠ€å·§ 2ï¼šæŸ¥çœ‹å†…å­˜å†…å®¹
```gdb
(gdb) x/16wx 0x80200000    # ä» 0x80200000 å¼€å§‹ï¼Œ16 ä¸ª 4 å­—èŠ‚å­—ï¼ˆå°ç«¯ï¼‰
(gdb) x/10i _start         # åæ±‡ç¼– _start ç¬¦å·å¤„çš„ 10 æ¡æŒ‡ä»¤
```

#### âŒ é—®é¢˜ï¼š`break main` æç¤º â€œNo symbol 'main' in current contextâ€
â†’ åŸå› ï¼šè¿˜æ²¡è·‘åˆ° `main` çš„ä»£ç æ®µï¼Œæˆ–ç¬¦å·æœªåŠ è½½ã€‚  
âœ… è§£å†³ï¼š
```gdb
(gdb) info functions main   # å…ˆæŸ¥ç¬¦å·æ˜¯å¦å­˜åœ¨
(gdb) symbol-file kernel.elf # é‡æ–°åŠ è½½ç¬¦å·ï¼ˆè‹¥ä¸¢å¤±ï¼‰
```

#### âŒ é—®é¢˜ï¼š`step` ç›´æ¥è·‘é£äº†
â†’ åŸå› ï¼šè·³è¿‡äº†å¯åŠ¨æ±‡ç¼–ï¼Œç›´æ¥è¿› C äº†ã€‚  
âœ… è§£å†³ï¼šå…ˆåœ¨ `_start` å¤„æ–­ç‚¹ï¼š
```gdb
(gdb) break _start
(gdb) continue
(gdb) stepi   # ç„¶åç”¨ stepi å•æ­¥æ±‡ç¼–
```

---

### ğŸ§ª äº”ã€å®æˆ˜å°ç»ƒä¹ ï¼ˆ5 åˆ†é’Ÿä¸Šæ‰‹ï¼‰

1. åœ¨ `main.c` ä¸­åŠ ä¸€ä¸ªå…¨å±€å˜é‡ï¼š
   ```c
   int count = 0;
   ```
2. åœ¨ `main` å‡½æ•°å¾ªç¯ä¸­åŠ ï¼š
   ```c
   count++;
   ```
3. é‡æ–° `make`
4. å¯åŠ¨ GDB è°ƒè¯•ï¼š
   ```gdb
   (gdb) b main
   (gdb) c
   (gdb) p count    # åº”è¯¥æ˜¯ 0
   (gdb) n          # æ‰§è¡Œ count++
   (gdb) p count    # åº”è¯¥æ˜¯ 1
   ```

---

### ğŸ“š æ¨èé€ŸæŸ¥è¡¨

- [GDB Cheat Sheet (PDF)](https://kapeli.com/cheat_sheets/GDB.docset/Contents/Resources/Documents/index)
- [RISC-V GDB è°ƒè¯•å®˜æ–¹æ–‡æ¡£](https://sourceware.org/gdb/current/onlinedocs/gdb/RISC_002dV.html)

---

éœ€è¦æˆ‘ä¸ºä½ å†™ä¸€ä¸ª **`debug.sh` è„šæœ¬**ï¼Œä¸€é”®å¯åŠ¨ QEMU+GDB è°ƒè¯•ç¯å¢ƒå—ï¼Ÿè¿˜æ˜¯æƒ³é’ˆå¯¹æŸä¸ªå…·ä½“é—®é¢˜ï¼ˆæ¯”å¦‚â€œå¦‚ä½•è°ƒè¯• trap å¤„ç†â€ï¼‰æ·±å…¥ï¼Ÿ  
å‘Šè¯‰æˆ‘ï¼Œæˆ‘ç«‹åˆ»ç»™ä½ å®šåˆ¶æ–¹æ¡ˆ ğŸ‘‡